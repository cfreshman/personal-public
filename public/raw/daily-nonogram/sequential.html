<!-- cyrusfreshman 2023 -->
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>daily nonogram</title> <script src=/copyright.js></script><meta data-hydrate data-style />
<style>
h1 {
    text-align: center;
    font-size: 2rem;
    margin: 1.5rem 0;

    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    justify-content: center;
    align-content: stretch;
    align-items: center;
}

img.logo {
    height: 3rem;
    width: 3rem;
    padding-left: 2rem;
    image-rendering: pixelated;
}

hr {
    width: 100%;
    border-top: 1px solid #8c8b8b;
}


#inputs {
    /* width: calc(100% - 2rem); */
    width: 100%;
    margin: .5rem auto;
    display: flex;
    justify-content: center;
    align-items: stretch;
}
#inputs form {
    flex-grow: 1;
}
input[type=text] {
    /* width: 700px; */
    flex-grow: 1;
    height: 1.3rem;
    margin: .3rem;
    text-indent: .15rem;
    border: 1px solid rgb(121, 121, 121);
    font-family: sans-serif;
}
label {
    display: flex;
    justify-content: flex-end;
    align-items: center;
}
.label {
    padding-right: 5px;
    min-width: 2.2rem;
    text-align: right;
}

button {
    margin: .3rem;
    border-radius: .15rem;
    background-color: #000;
    color: #fff;
    border: none;
}
button:focus {
    outline: none;
}

button.lg {
    font-size: 1.25rem;
    padding: 1rem;
}

button.sm {
    font-size: 1rem;
    padding: .5rem;
}


#slider {
    width: 100%;
    /* height: .5rem; */
    padding: .5rem;
    display: flex;
    flex-direction: column;
    align-items: stretch;
}
#slider input {
    flex-grow: 1;
}
#slider label {
    /* min-width: 7rem; */
    /* margin-right: .5rem; */
    display: flex;
    justify-content: center;
}

#custom-handle {
    width: 4rem;
    height: 1.6rem;
    top: 50%;
    margin-top: -.8rem;
    margin-left: -2.075rem;
    text-align: center;
    line-height: 1.6rem;
}
#custom-handle:focus {
    outline: none;
}
#custom-handle.ui-state-active {
    border: 1px solid #000;
    background: #000;
}


/* .board { */
    /* min-height: 8rem; */
    /* height: fit-content; */
    /* margin: 2px 2px 4px; */
    /* flex-grow: 1; */
    /* width: calc(100% - 16rem); */
    /* width: max-content;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
} */
table {
  position: relative;
  user-select: none;
}
/* table, tbody, tr, td {
    border-collapse: collapse;
} */
/* default table display bad. very bad. too bad. */
tbody {
    display: flex;
    flex-direction: column;
}
tr:not(.numbers) {
    display: flex;
    border: 2px solid #000;
    border-width: 0 2px;
}
tr.numbers + tr { border-top-width: 2px }
tr:last-child { border-bottom-width: 2px }

tr {
    font-size: 0;
}

td {
    /* border: 1px solid #929292; */
    display: inline-flex;
    justify-content: center;
    align-items: center;
    box-sizing: border-box;
    /* width: 24px;
    height: 23px;
    font-size: 24px; */
    width: 1.5rem;
    height: calc(1.5rem - 1px);
    /* font-size: 1.5rem; */
    font-size: 16px;
}
td:not(.numbers) {
    /* border: 1px solid #00000006 !important; */
    /* margin-bottom: -1px !important; */
}

td.highlight {
    /* border-color: #252525; */
    /* border-color: #0175ff; */
    background: #0175ff88;
    /*border-width: 2px;*/
    border: 0;
    color: #0175ff !important;
}
td.v1.highlight {
    background: #0175ff !important;
    border: 0;
}

tr:not(.numbers) {
    background: #fff;
    /* box-shadow: 2px 0 #000, -2px 0 #000; */
}
/* table::after, tr:first-child::after {
    position: absolute;
    content: "";
    height: 2px;
    width: calc(100% + 4px);
    left: 0;
    margin-left: -2px;
    background: #000;
} */
tr:first-child {
    position: relative;
}
tr:first-child::after {
    bottom: 0;
}

table.composed::after, .composed tr:first-child::after {
    background: #0002;
    background: #0000;
}
.composed tr:not(.numbers) {
    box-shadow: 2px 0 #0002, -2px 0 #0002;
}
table.composed {
    /* background: #0002; */
    border: 2px solid #0000 !important;
}
table.composed * {
    background: #0000;
    border-color: #0002 !important;
    border-color: #0000 !important;
}

/* .unsolved table:not(.composed) tr:not(.numbers) td[data-tile]:hover {
    background: #000;
    cursor: pointer;
} */
.unsolved .v2 {
    position: relative;
    display: inline-flex;
    align-items: center; justify-content: center;
    font-size: 16px !important;
}
/* .unsolved.mode-v2 table:not(.composed) tr:not(.numbers) td[data-tile]:hover {
    background: none;
    font-size: 20px !important;
} */
.unsolved .v2::after
/* , .unsolved.mode-v2 table:not(.composed) tr:not(.numbers) td[data-tile]:hover::after */
{
    content: "⨉";
    position: absolute; align-items: center; justify-content: center;
    font-size: inherit !important;
    z-index: 1;
    text-shadow: 0.25px 0.25px #000, -0.25px -0.25px #000, 0.25px -0.25px #000, -0.25px 0.25px #000, 0px 0.5px #000, 0.5px 0px #000, 0px -0.5px #000, -0.5px 0px #000;
}
.unsolved.mode-v2 .numbers.down.across > div {
    color: #fff;
    background: #000;
    padding-right: 0;
}
.unsolved [date-tile] {
    cursor: pointer;
    pointer-events: all;
}
/* tr:not(.numbers) td:hover {
    background: #000;
    cursor: pointer;
} */

/* td.highlight.down {
    border-right-width: .05rem;
    border-left-width: .05rem;
}

td.highlight.across {
    border-top-width: .05rem;
    border-bottom-width: .05rem;
} */

td.selected {
    background: rgba(0, 0, 0, .5);
}


tr.numbers {
    border: none;
}
td.numbers {
    border: none;
    justify-content: flex-end;
    align-content: center;
}
.numbers div {
    font-size: .7rem;
    height: .9rem;
}

tr {
  position: relative;
}
td.numbers.down:not(.across) {
    height: auto;
    flex-direction: column;
    vertical-align: bottom;
    padding: 0;
    padding-bottom: .3rem;
}

td.border.vertical {
    position: relative;
}
td:has(div.numbers.across) {
    position: absolute;
    left: calc(100% + .5rem);
    width: unset;
    background: none;
}
div.numbers.across {
    display: flex;
}
div.numbers.across div {
    padding-right: .5rem;
}
tr.numbers {
    display: flex;
}
td:has(.numbers.across.down) {
    /* bottom: .5rem;
    top: calc(100% - .5rem); height: 0; */
    bottom: .5rem;
}
div.numbers.across.down div {
    font-size: .9rem;
}


td.border {
    padding: 0;
    border: none;
    background: #000;
}
tr:first-child td.not.border {
    background: none;
}

tr.border {
    display: flex;
}
td.border.horizontal {
    height: .2rem;
    height: 0;
    flex: 1 0;
    border: 0 !important;
}
td.not.border.horizontal {
    flex: 0 0 .15rem;
}
td.end.not.border.horizontal {
    flex: 0 0 0;
    background: none;
}

td.border.vertical {
    /* width: .2rem; */
    /* display: none; */
    width: 0;
    border: 0 !important;
}

:root {
    --fill-color-default: #000;
    --fill-color-0: #6c6c6c;
    --fill-color-1: red;
    /* --fill-color-1: #ff2626; */
    /* --fill-color-2: #ffde00; */
    --fill-color-2: #ffb210;
}
td[data-tile] {
    --fill-color: var(--fill-color-default);
}
:is(td[data-tile].color-0, .board:nth-child(3) td[data-tile]) {
    --fill-color: var(--fill-color-0);
}
:is(td[data-tile].color-1, .board:nth-child(4) td[data-tile]) {
    --fill-color: var(--fill-color-1);
}
:is(td[data-tile].color-2, .board:nth-child(5) td[data-tile]) {
    --fill-color: var(--fill-color-2);
}
.red:not(.colored) :is(td[data-tile].color-0, .board:nth-child(3) td[data-tile]) {
    --fill-color: var(--fill-color-1);
}
.red:not(.colored) :is(td[data-tile].color-1, .board:nth-child(4) td[data-tile]) {
    --fill-color: var(--fill-color-2);
}
.red:not(.colored) :is(td[data-tile].color-2, .board:nth-child(5) td[data-tile]) {
    --fill-color: var(--fill-color-3);
}
.yellow:not(.colored) :is(td[data-tile].color-0, .board:nth-child(3) td[data-tile]) {
    --fill-color: var(--fill-color-2);
}
.yellow:not(.colored) :is(td[data-tile].color-1, .board:nth-child(4) td[data-tile]) {
    --fill-color: var(--fill-color-0);
}
.yellow:not(.colored) :is(td[data-tile].color-2, .board:nth-child(5) td[data-tile]) {
    --fill-color: var(--fill-color-1);
}

.v0 {

}
.v1 {
    background-color: var(--fill-color) !important;
    /* border: 1px solid #252525; */
    border-color: #000;
}

.v2 {
    font-family: 'Coiny', 'Roboto Slab', sans-serif;
    padding: 0;
}
.v2.done {
    color: #00000000;
    border: 1px solid #9292921f;
}
.v2.done.slow {
    transition: 1s ease-out;
}

.guess.v1 {
    font-family: 'Coiny', 'Roboto Slab', sans-serif;
    padding-top: .4rem;
    padding-left: .1rem;
    color: #fff;
}


#examples {
    display: flex;
    justify-content: center;
    align-items: center;
}

button, #custom-handle {
    cursor: pointer;
}

@media screen and (max-aspect-ratio: 2/3) {
    html {
        overflow: hidden;
        min-height: fit-content;
    }
}
@media screen and (min-aspect-ratio: 2/3) {
    .unsolved table:not(.composed) tr:not(.numbers) td[data-tile]:hover {
        background-color: var(--fill-color) !important;
        cursor: pointer;
    }
    .unsolved .v2 {
        position: relative;
        display: inline-flex;
        align-items: center; justify-content: center;
        font-size: 20px !important;
    }
    .unsolved.mode-v2 table:not(.composed) tr:not(.numbers) td[data-tile]:not(.v1):hover {
        background: none !important;
        /* font-size: 1em; */
        font-size: 20px !important;
    }
    .unsolved.mode-v2 table:not(.composed) tr:not(.numbers) td[data-tile]:not(.v1):hover::after {
        content: "⨉";
        position: absolute; align-items: center; justify-content: center;
        font-size: inherit !important;
        z-index: 1;
        text-shadow: 0.25px 0.25px #000, -0.25px -0.25px #000, 0.25px -0.25px #000, -0.25px 0.25px #000, 0px 0.5px #000, 0.5px 0px #000, 0px -0.5px #000, -0.5px 0px #000;
    }
}


</style>
</head>
<body>

<!-- <div>[WIP]</div> -->
<div id=examples style="
display: none;
"></div>
<br  style="
display: none;
" />
<div id=ui>
    <!-- <br /> -->
    <!-- <div id=input-controls class=input-empty style="
    flex-wrap: wrap;
    ">
        <span id=name-label class=input-only></span>
    </div> -->
    <form id=solve-input style="
    flex-direction: column;
    margin: 2px 0;
    display: none;
    ">
        <input type=text id=solve-input-down name=down autocomplete=off contenteditable>
        <input type=text id=solve-input-across name=across autocomplete=off contenteditable>
    </form>
    <div id=display-input style="
    flex-direction: column;
    margin: 2px 0;
    width: fit-content;
    ">
        <div id=display-input-down></div>
        <div id=display-input-across></div>
    </div>
    <!-- <br /> -->
    <div id=input-controls class=input-empty>
        <span id=name-label class=input-only></span>
        <!-- <label id=morse-label><input type=checkbox /><span>morse code</span></label> -->
        <label id=sequential-label><input type=checkbox /><span>sequential display</span></label>
        <label id=placement-label><input type=checkbox /><span>placement guide</span></label>
        <a href=puzzle.html><span>puzzle.html</span></a>
    </div>
    <!-- <div>
        <label id=more-label><input type=checkbox />&nbsp;morse code</label>
    </div> -->
    <div style="display:none">
        <a id=variant-button class=hidden>variant</a>
        <a id=solve-button class=hidden>solve</a>
        <div style="flex-basis:100%"></div>
        <a id=save-button>save</a>
        <!-- <a id=export-button>export</a> -->
        <!-- <select id=save-select>
            <option value="cancel">save</option>
            <option value="image">image</option>
            <option value="export">export</option>
        </select> -->
        <!-- <span id=save-widget class=composite-select>
            <a>save</a>
            <select>
                <option value="cancel">cancel</option>
                <option value="image">image</option>
                <option value="export">export</option>
            </select>
        </span> -->
        <a id=reset-button>reset</a>
        <!-- <a id=previous-button>←</a><a id=next-button>→</a> -->
        <a id=first-button>|&lt;</a>
        <a id=previous-button>&lt;-</a>
        <a id=random-button>??</a>
        <a id=next-button>-&gt;</a>
        <a id=last-button>&gt;|</a>
        <select id=theme-select class=hidden>
            <option value="grayscale">grayscale</option>
            <option value="red">red</option>
            <option value="yellow">yellow</option>
        </select>
    </div>
</div>
<br/><br/>
<div id=objects></div>
<!-- <div class=spacer></div> -->
<div data-hydrate data-title></div>
<div>&nbsp;</div>
<style>
    body > * {
        min-width: max-content;
    }
    .composite-select {
        position: relative;
    }
    .composite-select select {
        position: absolute;
        top: 0; left: 0;
        z-index: -1;
    }
    #objects {
        display: flex; flex-direction: column;
    }
    #objects > * {
        margin-bottom: 1.5em;
    }
    #ui {
        width: -webkit-fill-available;
        user-select: none;
    }
    #input-controls > .hidden {
        visibility: hidden;
    }
    #ui > *, #examples {
        display: flex;
        justify-content: flex-start;
        gap: 1px .67em;
        width: -webkit-fill-available;
    }
    #ui > * > input {
        width: 100%;
        border-radius: 0;
        border: 1px solid currentcolor;
        margin: -1px;
        padding: 2px 0;
        font-family: inherit;
        outline: 0;
        font-size: 1em !important;
    }
    #ui > * > select {
        -webkit-appearance: none;
        color: #000;
        background: #fff;
        font-family: inherit;
        outline: 0;
        border: 0;
        cursor: pointer;
        text-decoration: underline;
        font-size: 1em !important;
    }
    .input-empty .input-only {
        opacity: .5;
        pointer-events: none;
    }
    .unsolved #input-controls .input-only {
        color: #0000;
        background: #aaa;
        pointer-events: none;
        user-select: none;
    }
    #input-controls {
        flex-wrap: wrap;
        /* align-items: flex-start; */
        gap: 1em;
        align-items: center;
        
        /* flex-direction: column; gap: 1px; align-items: flex-start; */
        margin-top: .75em;
    }
    #input-controls #name-label {
        text-transform: uppercase;
    }
    #input-controls > :not(:first-child) {
        font-size: .67em !important;
        cursor: pointer;
        padding: 1px;
        /* padding: 0; */
        display: flex; align-items: stretch; justify-content: center;
        /* border-radius: 3px !important; overflow: hidden; */
    }
    #input-controls > :not(:first-child) span {
        /* padding: 0 .5em !important; */
        padding-left: .5em !important;
    }
    #input-controls > :not(:first-child):hover {
        background: #000;
        color: #fff;
    }
    #input-controls input[type=checkbox], #input-controls > a::before {
        -webkit-appearance: none;
        height: 1em; width: 1em;
        /* margin: 0 0.85em; */
        margin: 0;
        display: inline-flex; align-items: center; justify-content: center;
        border: 1px solid currentcolor;
        border: .5px solid currentcolor;
        /* border-radius: 2px; */
        /* box-shadow: 0 0 1px currentcolor; */
        box-sizing: content-box;
    }
    #input-controls #morse-label input[type=checkbox]:not(:checked), #input-controls #morse-label:hover input[type=checkbox]:checked {
        background: var(--fill-color-2) !important;
    } 
    #input-controls #placement-label input[type=checkbox]:not(:checked), #input-controls #placement-label:hover input[type=checkbox]:checked {
        background: var(--fill-color-1) !important;
    }
    #input-controls > :not(:first-child) input[type=checkbox]:checked {
        background: #000 !important;
        /* border-color: #fff !important; */
    }
    #input-controls > :not(:first-child):hover input[type=checkbox], #input-controls#input-controls > :not(:first-child):hover input[type=checkbox]:not(:checked) {
        background: #fff !important;
        color: #000 !important;
    }
    #input-controls > a {
        text-decoration: none;
    }
    #input-controls > a::before {
        content: ">";
        /* content: '↗'; */
        background: #fff;
        color: #000;
    }


    :root {
        --alt: #000;
        --display-pad-outer: .125em;
        --display-radius-inner: .375em;
    }
    body {
        padding: .75em;
    }
    .unsolved #name-label {
        overflow: hidden;
        white-space: pre;
        background: #000000d8 !important; color: #fff !important;

        background: #aaa !important;
        background: #888 !important;
        background: var(--alt) !important;
    }
    .unsolved .board:has(.composed) {
        display: none;
    }
    .unsolved #name-label, #display-input > *, .guide table:not(.composed) tr.numbers::after, .guide table:not(.composed) tr:nth-child(2)::after {
        border: 0; padding: 0;
        letter-spacing: .05em;
        font-family: highway-gothic;
    }
    #ui, #display-input {
        display: flex;
        flex-direction: column;
        /* gap: 4px; */
        color: var(--alt);

        /* gap: .5rem; */
        gap: var(--display-pad-outer);
    }
    #display-input > * {
        display: flex; flex-direction: row;
        /* gap: .125em; */
        gap: var(--display-pad-outer);
        padding: var(--display-pad-outer);
        border-radius: calc(var(--display-radius-inner) + var(--display-pad-outer));
        background: var(--fill-color-2);
        width: fit-content;
    }
    #display-input > * > * {
        display: flex;
        align-items: center;
        justify-content: center;
        /* gap: 2px; */
        width: fit-content;

        background: var(--alt);
        /* border-radius: inherit; */
        border-radius: var(--display-radius-inner);
        /* padding: 0 2px; */
        /* box-shadow: inset 0 0 0 2px var(--alt); */
        /* gap: 2px; */
        /* border-radius: 16px; */
        border: 1px solid currentcolor;
        color: #000;
        gap: 0 !important;
    }
    #display-input > * > * > *, .guide table:not(.composed) tr.numbers::after, .guide table:not(.composed) tr:nth-child(2)::after {
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: highway-gothic;
        border-radius: 16px;
        border-radius: 0;
        color: var(--alt);
    }
    #display-input > * > * > * {
        overflow: hidden !important;
        color: #000;
        border: 0 !important;
    }
    #display-input > * > * > :first-child {
        border-top-left-radius: inherit;
        border-bottom-left-radius: inherit;
    }
    #display-input > * > * > :last-child {
        border-top-right-radius: inherit;
        border-bottom-right-radius: inherit;
    }
    #display-input > * > * > :nth-child(2n + 1) {
        background: var(--alt); color: #fff;
    }
    .unsolved #name-label {
        /* font-size: 1.5em !important; */
    }
    #solve-input input {
        /* font-family: highway-gothic; */
        font-size: 44px !important;
    }
    #objects .board {
        order: 0;
    }
    #objects .board:has(.composed) {
        order: 1;
    }
    #objects {
        /* gap: .5em; */
        /* margin-top: 1.5em; */
        flex-grow: 1;
    }

    .morse #name-label {
        /* color: var(--fill-color-2) !important; */
    }

    .guide table:not(.composed) tr.numbers::after, .guide table:not(.composed) tr:nth-child(2)::after {
        display: flex;
        /* align-items: center;
        justify-content: center; */
        align-items: flex-start;
        justify-content: flex-start;
        position: absolute;
        z-index: 100;
        /* background: #000; color: var(--fill-color-1) !important; */
        /* background: var(--fill-color-1); color: #000 !important; */
        color: #000 !important; background: none;
        font-size: 12px !important;
        overflow: visible;
        font-size: 40px !important;
        padding: 0 .5em;
        box-sizing: border-box;

        /* border-radius: var(--display-radius-inner); */
        /* margin: var(--display-pad-outer); */
        /* padding: 0; */
        /* border: 1px solid #000; */
        /* padding: 0 var(--display-pad-outer); */
        padding: 0;
        white-space: pre-wrap;
    }
    .guide table:not(.composed) tr.numbers::after {
        content: "1:1→";
        /* bottom: -50%; */
        left: 0;
        bottom: 0;
        /* top: 0; */
        /* left: var(--display-pad-outer); */
        width: 100%;
        height: max-content;
        /* margin-bottom: 2px; */
        height: calc(1em + 2 * var(--display-pad-outer));
        
        padding: 0; height: 1em;
        height: max-content; line-height: 1;
    }
    .guide table:not(.composed) tr:nth-child(2)::after {
        content: "2:1    ↓";
        /* top: 33%; */
        top: -2px;
        /* left: calc(100% + 2px); */
        left: 100%;
        /* left: calc(100% - .5em); */
        /* top: calc(var(--display-pad-outer) - 2px); */
        /* left: calc(100% - 2px - 3 * var(--display-pad-outer)); */
        width: max-content;
        margin-left: 2px;
        /* line-height: 1.3; */
        line-height: 1;

        width: 100px;
        /* display: flex; align-items: center; justify-content: center; */
    }
    .guide .board:nth-child(3) table:not(.composed) tr.numbers::after {
        content: "1:2→";
    }
    .guide .board:nth-child(3) table:not(.composed) tr:nth-child(2)::after {
        content: "2:2    ↓";
    }
    .guide .board:nth-child(4) table:not(.composed) tr.numbers::after {
        content: "1:3→";
    }
    .guide .board:nth-child(4) table:not(.composed) tr:nth-child(2)::after {
        content: "2:3    ↓";
    }
    .guide table:not(.composed) .numbers {
        color: #0000 !important;
    }
    .guide table:not(.composed) tr:not(.numbers) {
        box-shadow: 100px 0 var(--fill-color-1);
        /* box-shadow: 100px 0 #0004, 100px 0 var(--fill-color-1); */
    }
    .guide table:not(.composed) tr:not(.numbers):nth-child(2n + 1) {
        box-shadow: 100px 0 #0003, 100px 0 var(--fill-color-1);
    }
    .guide table:not(.composed) td.numbers.down:not(.across) {
        /* box-shadow: 0 -100px var(--fill-color-1); */
        /* box-shadow: 100px 0 #0004, 100px 0 var(--fill-color-1); */
        min-height: calc(2em + 2px + 2 * var(--display-pad-outer));
        background: var(--fill-color-1);
    }
    .guide table:not(.composed) td.numbers.down:not(.across):nth-child(2n + 1) {
        background: linear-gradient(#0003 0 0) var(--fill-color-1);
    }

    body{background:#fff}
    body:has(#sequential-display-container) > :not(#sequential-display-container) {display:none}
    #sequential-display-container {
        position: fixed; height: 100%; width: 100%; top: 0; left: 0;
        z-index: 100100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: .25rem solid transparent;
        /* margin: .25rem; */
    }
    #sequential-display-container-inner {
        height: 100%; width: 100%;
        display: flex; align-items: center; justify-content: center;
    }
    #sequential-display {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        /* padding: .5em; */
        text-transform: uppercase;
        white-space: pre-line;
        font-family: highway-gothic;
    }
    #sequential-display * {
        font-family: inherit;
    }

    .appear-100 {
        animation: appear-100 100ms;
    }
    @keyframes appear-100 {
        0% { visibility: hidden }
        100% { visibility: hidden }
    }
</style>

  <script>
const MAX_INPUT_DIM = 31

var allPos = {};
function getAllPos(size, nums) {
    if (nums.length === 0 || nums[0] === 0)
        return [0];

    let key = [size].concat(nums).join();
    if (allPos[key] !== undefined)
        return allPos[key];

    let [n, endNums] = [nums[0], nums.slice(1)];
    let minEndSize = endNums.reduce((acc, n) => acc+n, 0) + endNums.length;
    let degrees = (size - n) - minEndSize + 1;

    let blockPerms = [];
    let bit_v = ((1 << n) - 1) << (size - n);
    for (let i = 0; i < degrees; i++) {
        if (endNums.length === 0) {
            blockPerms.push(bit_v);
        } else {
            let endSize = size - ((n + 1) + i);
            let ends = getAllPos(endSize, endNums);
            for (let e_i = 0; e_i < ends.length; e_i++)
                blockPerms.push(bit_v | ends[e_i]);
        }

        bit_v >>>= 1;
    }

    allPos[key] = blockPerms;
    return blockPerms;
}

var moves;
function solve(down, across, unsolved=false, dryrun=false) {
    console.debug('solve', down, across)
    let board
    if (down[0] && down[0][0].length && down.length === across.length) {
        board = range(down.length).map(i => solve(down[i], across[i], unsolved, true))
    } else {
        let rows = [];
        for (let i = 0; i < across.length; i++) rows[i] = [0, 0];

        let cols = [];
        for (let i = 0; i < down.length; i++) cols[i] = [0, 0];

        board = {
            down: down,
            across: across,
            rows: rows,
            cols: cols
        };
    }

    if (!dryrun) {
        constructBoard(board, false);
        document.documentElement.classList[unsolved ? 'add' : 'remove']('unsolved')
    }
    if (unsolved || Array.isArray(board)) return board

    moves = [];
    possiblePos = {};

    let downUpdated = updateVectors(false, board);
    let acrossUpdated = updateVectors(true, board);
    while (downUpdated || acrossUpdated) {
        downUpdated = (acrossUpdated) ? updateVectors(false, board) : false;
        acrossUpdated = (downUpdated) ? updateVectors(true, board) : false;
    }

    if (!isSolution(board)) board = trySolve(board) || board;

    return board;
}
const dims = (board) => Array.isArray(board) ? dims(board[0]) : [board.across.length, board.down.length]

function trySolve(board) {
    if (Array.isArray(board)) return board.map(trySolve)
    console.log();
    console.log("decision point reached");
    logB(board);

    let allPosCopy = JSON.parse(JSON.stringify(allPos));
    let possiblePosCopy = JSON.parse(JSON.stringify(possiblePos))

    let size = board.cols.length;
    for (let r = 0; r < board.rows.length; r++) {
        let row = board.rows[r];
        if ((row[0] ^ row[1]) === ((1 << size)-1))
            continue;

        let unknown_v = ~(row[0] ^ row[1]);
        for (let c = 0; c < board.cols.length; c++) {
            if (unknown_v & 1) {
                let tryBoard = JSON.parse(JSON.stringify(board));

                tryBoard.rows[r][0] |= (1 << c);

                moves.push({
                    guess: true,
                    val: 1,
                    pos: [r, board.cols.length - 1 -c]
                });

                fixVectors(tryBoard.cols, board.rows.length, tryBoard.rows[r], r);

                console.log(r, c);
                console.log(b(tryBoard.rows[r][0], size));

                try {
                    let downUpdated = updateVectors(false, tryBoard);
                    let acrossUpdated = updateVectors(true, tryBoard);
                    if (downUpdated || acrossUpdated) {
                        while (downUpdated || acrossUpdated) {
                            downUpdated = (acrossUpdated) ? updateVectors(false, tryBoard) : false;
                            acrossUpdated = (downUpdated) ? updateVectors(true, tryBoard) : false;
                        }

                        if (!isSolution(tryBoard))
                            tryBoard = trySolve(tryBoard);

                        if (tryBoard)
                            return tryBoard;
                    }
                } catch (e) {}

                allPos = JSON.parse(JSON.stringify(allPosCopy));
                possiblePos = JSON.parse(JSON.stringify(possiblePosCopy));
                moves.push({
                    reset: JSON.parse(JSON.stringify(board))
                })
            }

            unknown_v >>= 1;
        }
    }

    return false;
}

var possiblePos = {};
function updateVectors(isRow, board) {
    let vectors = (isRow) ? board.rows : board.cols;
    let size = (isRow) ? board.cols.length : board.rows.length;

    let isChanged = false;
    for (let i = 0; i < vectors.length; i++) {
        let nums = (isRow) ? board.across[i] : board.down[i];
        let [true_v, false_v] = vectors[i];

        moves.push({
            isRow: isRow,
            i: i
        });

        let key = [isRow, i].join();
        let prev = possiblePos[key] || getAllPos(size, nums);
        let possible = prev.filter(
            v => (v & true_v) === true_v && (v & false_v) === 0
        )
        possiblePos[key] = possible;

        if (possible.length === 0) {
            console.log(isRow, i);
            logB(board);
            throw 'Invalid board';
        }

        true_v |= possible.reduce((acc, v) => acc & v);
        false_v |= possible.reduce((acc, v) => acc | v) ^ ((1 << size) - 1);

        let diff_true = true_v ^ vectors[i][0];
        let diff_false = false_v ^ vectors[i][1];
        let unknown = ~(true_v ^ false_v);

        let toAdd = [];
        for (let j = size-1; j >= 0; j--) {
            if ((diff_true & 1) || (diff_false & 1)) {
                toAdd.push({
                    isRow: isRow,
                    i: i,
                    val: (diff_true & 1) ? 1 : 2,
                    pos: isRow ? [i, j] : [j, i]
                });
            }

            if ((diff_true & 1) || (diff_false & 1) || (unknown & 1)) {
                toAdd.push({
                    isRow: isRow,
                    i: i,
                    val: 0,
                    pos: isRow ? [i, j] : [j, i]
                });
            }

            diff_true >>= 1;
            diff_false >>= 1;
            unknown >>= 1;
        }
        moves.push(...toAdd.reverse());

        if (true_v !== vectors[i][0] || false_v !== vectors[i][1]) {
            isChanged = true;
            vectors[i] = [true_v, false_v];
            fixVectors( (isRow) ? board.cols : board.rows, vectors.length, vectors[i], i);
            moves.push({
                isRow: isRow,
                i: i
            });
        }
    }

    // moves = (getMoveTime() > 0) ? moves : [];
    // console.log(moves);

    return isChanged;
}

function fixVectors(vectors, size, fix, index) {
    let [true_v, false_v] = fix;
    let pos = size - index - 1;
    for (let i = vectors.length-1; i >= 0; i--) {
        vectors[i][0] |= ((true_v & 1) << pos);
        vectors[i][1] |= ((false_v & 1) << pos);
        true_v >>= 1;
        false_v >>= 1;
    }
}

function isSolution(board) {
    return board.rows.every(r => (r[0] ^ r[1]) === ((1 << board.cols.length)-1));
}

function convertBoard(board) {
    if (board.layers) {
        return board.layers
        .map(convertBoard)
        .reduce((a, v, i) => a.map((a_r, r_i) => a_r.map((x, c_i) => x !== 1 ? v[r_i][c_i] === 1 ? 2 + i : v[r_i][c_i]  : x)))
    }

    let converted = [];
    for (let r = 0; r < board.rows.length; r++) {
        let boxes = [];
        let [true_v, false_v] = board.rows[r];
        for (let c = 0; c < board.cols.length; c++) {
            let val = (true_v & 1) | ((false_v & 1) << 1);
            boxes.unshift(val);
            true_v >>= 1;
            false_v >>= 1;
        }
        converted.push(boxes);
    }
    return converted;
}

function logB(board) {
    let converted = convertBoard(board);
    for (let i = 0; i < converted.length; i++)
        console.log(i.toString().padStart(3) + '| ',
            converted[i].join(' ')
            .split('0').join('?')
            .split('1').join('O')
            .split('2').join(' '));
    if (!isSolution(board))
        console.log('Incomplete');
}

function bl(l, size) {
    return l.map(v => b(v, size));
}

function b(v, size) {
    return ((v >>> 0) & ((1 << size) - 1)).toString(2).padStart(size, '0');
}


function parseNums(line) {
    if (line.includes('|')) return line.split('|').map(parseNums)
    
    let groups = line.trim().split('|')[0].split(/ +/g).filter(g => g);
    let nums = groups.map(g => g.trim().split(',').map(Number));
    return nums;
}

function boardToCanvas(target_table_l=Q('table')) {
    if (!(/table/i.test(target_table_l.tagName))) target_table_l = target_table_l.querySelector('table')
    if (!target_table_l) return undefined

    const canvas = node('<canvas style="image-rendering:pixelated"></canvas>')
    ;[canvas.height, canvas.width] = [QQ(target_table_l, 'tr:not(.numbers, .border)').length, QQ(target_table_l, 'tr:nth-child(2) td').length]
    const ctx = canvas.getContext('2d')
    ctx.fillStyle  = '#e5e5e5' // '#fff'
    ctx.fillRect(0, 0, canvas.width, canvas.height)
    QQ(target_table_l, '[data-tile]').map((x, i) => {
        const r = Math.floor(i / canvas.width)
        const c = i % canvas.width
        ctx.fillStyle = getComputedStyle(x).backgroundColor
        ctx.fillRect(c, r, 1, 1)
        console.debug(c, r, ctx.fillStyle, x, i, canvas.width, canvas.height)
    })
    console.debug(QQ(target_table_l, '[data-tile]'), canvas.toDataURL())
    return canvas
}

var valMap = [' ', '', '⨉'];
const cleanup = []
function constructBoard(board, isFinal=true, board_container_l=Q('#objects')) {
    cleanup.map(apply)
    lists.clear(cleanup)

    console.debug('construct', board)
    const _inner = async (board, board_l, i=0) => {
        let boardVals = convertBoard(board);
        console.debug(board, boardVals);
        let innerHTML = `<table${board.layers ? ' class=composed' : ''} onclick="event.preventDefault()">`;
        let borderAcross = `<tr class="border">
            <td class="border horizontal"></td>
            ${(window.chrome || window.parent?.chrome) ? '<td class="numbers end not border horizontal"></td>' : ''}
        </tr>\n`;
        let borderDown = '<td class="border vertical"></td>';
        if (!board.layers) {
            innerHTML += `<tr class="numbers">`
            // innerHTML += `<td class="numbers down across"><div>${board.rows.length}x${board.cols.length}</div></td>`
            innerHTML += `<td class="not border vertical">
                <div class="numbers down across"><div>${boardVals.length}x${boardVals[0].length}</div></div>
            </td>`;
            for (let c = 0; c < boardVals[0].length; c++) {
                innerHTML += `<td class="numbers down"><div>${board.down[c].join('</div><div>')}</div></td>`;
            }
            innerHTML += '<td class="not border vertical"></td></tr>\n';
        }

        // innerHTML += borderAcross;
        for (let r = 0; r < boardVals.length; r++) {
            innerHTML += '<tr>'
            // innerHTML += `<td class="numbers across"><div>${board.across[r].join('</div><div>')}</div></td>`
            if (!board.layers) innerHTML += `<td class="border vertical r${r}">
                <div class="numbers across"><div>${board.across[r].join('</div><div>')}</div></div>
            </td>`;
            for (let c = 0; c < boardVals[0].length; c++) {
                innerHTML += `<td data-tile=${r}-${c} class="r${r} c${c} v${boardVals[r][c] < 3 ? boardVals[r][c] : `1 color-${i - 0}`}">${valMap[boardVals[r][c]]||''}</td>`;
            }
            // innerHTML += `<td class="border vertical r${r}"></td>` + '</tr>';
            innerHTML += '</tr>'
        }
        // innerHTML += borderAcross;
        innerHTML += '</table>';

        board_l.innerHTML = innerHTML;
        QQ(board_l, '.r0').map(x => x.classList.add(...list('border-top')));
        QQ(board_l, '.c0').map(x => x.classList.add(...list(('border-left'))));
        QQ(board_l, `.r${boardVals.length - 1}`).map(x => x.classList.add(...list(('border-bottom'))));
        QQ(board_l, `.c${boardVals[0].length - 1}`).map(x => x.classList.add(...list(('border-right'))));
        if (isFinal) {
            Q(board_l, '.highlight')?.classList.remove(...list('highlight down across'));
            if (getMoveTime() > 0) {
                setTimeout(() => QQ(board_l, '.v2').map(x => x.classList.add(...list(('slow done')))))
            } else {
                QQ(board_l, '.v2')?.map(x => x.classList.add(...list('done')))
            }
        } else {
            QQ(board_l, '.v2')?.map(x => x.style.cssText += 'visibilty:visible')
        }

        if (boardVals[0].length === 1) {
            QQ(board_l, 'tr.border').map(x => x.style.cssText += 'width:1.9rem');
        } else {
            QQ(board_l, 'tr.border').map(x => x.style.cssText += 'width:auto');
        }
        Q(board_l, 'table').style.cssText += 'visibility:hidden'
    }

    board_container_l.innerHTML = ''
    const compose = Array.isArray(board)
    if (!compose) board = [board]
    ;{
        console.debug('render board', { board })
        ;(compose
        ? [{layers:board,...board[0]},...board]
        : board
        ).map((part, i) => {
            const part_l = node(`<div class=board id=board_${i}></div>`)
            _inner(part, part_l, i)
            board_container_l.append(part_l)
        })
        Q('#theme-select').classList[compose ? 'remove' : 'add']('hidden')
        Q('#theme-select').click()
    }

    const MODES = ['v1', 'v2']
    let example, down, v_remove, action, save, stack, mode = MODES[0]
    const rotateMode = e => {
        mode = MODES[(MODES.indexOf(mode) + 1) % MODES.length]
        console.debug({ mode })
        html.classList.remove(...MODES.map(mode => `mode-${mode}`))
        html.classList.add(`mode-${mode}`)
    }
    const renderLabel = () => {
        // Q('#name-label').textContent = (example && !unsolved && (example?.title || example?.name)) || datetime.yyyymmdd()

        const target_fill_count = QQ(Q('table.composed'), 'td[data-tile]').filter(x => x.classList.contains('v1')).length
        const actual_fill_count = math.sum(board.flatMap(layer => layer.down.map(math.sum)))
        console.debug({ target_fill_count, actual_fill_count, board })
        const unsolved = target_fill_count !== actual_fill_count
        html.classList[unsolved ? 'add' : 'remove']('unsolved')
        Q('#name-label').textContent = (!unsolved && (example?.title || example?.name)) || location.hash.slice(1) || datetime.yyyymmdd() // String(Math.floor((puzzle_ms - start_ms) / duration({ d:1 }))).padStart(3, '0')

    }
    on(window, 'pointerup pointercancel', e => {
        down = false
    })
    cleanup.push(on(window, 'pointerup', e => {
        // down = false
        renderLabel()
        // Q('#name-label') = example?.title ||
        // const solved_board_l = !isFinal && node('<div></div>')
        // try {
        //     // if (!isFinal) constructBoard(trySolve(board), false, solved_board_l)
        // } catch {}
        // if (!isFinal && solved_board_l && boardToCanvas()?.toDataURL() === boardToCanvas(solved_board_l)?.toDataURL()) {
        //     constructBoard(board)
        //     const example = examples.find(x => compare.stringify(x.down, Q('[name=down]')) && compare.stringify(x.across, Q('[name=across]')))
        //     Q('#name-label') = example?.title || yyyymmdd()
        // }
    }))
    defer(() => {
        resizeBoard()

        example = examples.find(x => 
            x.down === Q('[name=down]').value
            && x.across === Q('[name=across]').value)
        defer(renderLabel)

        const composed = Q('table.composed')
        const layers = QQ('table:not(.composed)')
        layers.map((table_l, i) => {
            const cells = QQ(table_l, 'tr:not(.numbers) td[data-tile]')
            const [height, width] = dims(board)
            cells.map((x, j) => {
                const r = Math.floor(j / height)
                const c = j % width
                cleanup.push(...ons(x, {
                    'pointerdown': e => {
                        down = true
                        // v_remove = MODES.filter(mode => x.classList.contains(mode))
                        save = cells.map(cell => [...cell.classList])
                        stack = []
                        const action_name = (x.classList.contains(mode) ? 'remove' : 'add')
                        action = (l) => {
                            if (!l) return
                            if (MODES.find(other => l.classList.contains(other) && other !== mode)) return
                            // l.classList.remove(...MODES)
                            // l.classList.remove(...v_remove)
                            l.classList[action_name](mode)
                            i > 0 && l.classList[action_name](`color-${i - 1}`)
                            if (composed && mode === MODES[0]) {
                                // Q(composed, `[data-tile="${l.dataset['tile']}"]`)?.classList[action_name](mode)
                                // i > 0 && Q(composed, `[data-tile="${l.dataset['tile']}"]`)?.classList[action_name](`color-${i - 1}`)
                                const cells = QQ(composed, '[data-tile]')
                                cells.map(cell => cell.classList.remove(...cell.classList))
                                layers.map(layer => {
                                    QQ(layer, '[data-tile]').map((cell, i) => cells[i].classList.add(...list(cell.classList)/*.filter(x => !x.startsWith('color-'))*/))
                                })
                                cells.map(cell => cell.classList.remove(...MODES.slice(1)))
                            }
                        }
                        action(x)
                        stack.unshift(x)
                    },
                    'pointermove': e => {
                        const l = e.target
                        if (down) {
                            if (stack[1] === l) {
                                cells.map((cell, i) => {
                                    cell.classList.remove(...cell.classList)
                                    cell.classList.add(...save[i])
                                })
                                stack.shift()
                                stack.map(cell => action(cell))
                            } else if (stack[0] !== l) {
                                action(document.elementFromPoint(e.clientX, e.clientY))
                                stack.unshift(x)
                            }
                        }
                    },
                }))
            })

            QQ(table_l, '.numbers.down.across').map(y => {
                y.style.cssText += `
                cursor: pointer;
                text-decoration: underline;
                `
                y.onclick = rotateMode
            })
        })
        cleanup.push(on(window, 'keydown', e => {
            console.debug(e, e.key, e.key === 'x')
            if (e.key === 'x') rotateMode(e)
        }))
    })

    return board_container_l
}

function updateBoard(move) {
    let timeScale = 1;
    QQ('.selected').map(x => x.classList.remove('selected'));
    if (move.reset) {
        let boardVals = convertBoard(move.reset);
        for (let r = 0; r < move.reset.rows.length; r++) {
            for (let c = 0; c < move.reset.cols.length; c++) {
              ;(x => {
                x.classList.remove(...list('v0 v1 v2'))
                x.classList.add(...list(`v${boardVals[r][c]}`))
              })(Q(`.r${r}.c${c}`))
              ;(x => {
                x.classList.remove(...list('guess'))
              })(Q(`.r${r}.c${c}.v0`))
              ;(x => {
                x.textContent = valMap[boardVals[r][c]]
              })(Q(`.r${r}.c${c}:not(.guess)`))
            }
        }
        timeScale = 2;
    } else {
        ;(x => {
          x.classList.remove(...list('highlight down across'))
        })(Q(`.highlight`))
        if (move.isRow) {
          ;(x => {
            x.classList.add(...list('highlight down across'))
          })(Q(`.r${move.i}`))
        } else {
          ;(x => {
            x.classList.add(...list('highlight down'))
          })(Q(`.c${move.i}`))
        }

        if (move.pos) {
            let [r, c] = move.pos;
            if (move.val === 0) {
                ;(x => {
                  x.classList.add(...list('selected'))
                  x.textContent = valMap[move.val]
                })(Q(`.r${r}.c${c}`))
            } else {
              ;(x => {
                  x.classList.remove(...list('v0'))
                  x.classList.add(...list(`v${move.val}`))
                  x.textContent = valMap[move.val]
                })(Q(`.r${r}.c${c}:not(.guess)`))
            }

            if (move.guess) {
              ;(x => {
                  x.classList.add(...list('guess'))
                  x.textContent = '?'
                })(Q(`.r${r}.c${c}`))
            }
            timeScale = 0;
        }
    }
    return timeScale;
}

const errorElement = (l) => {
    if (!l) return
    const _t = l.style.cssText
    l.style.cssText += `
    background: #f00d;
    `
    setTimeout(() => l.style.cssText = _t, 1_000)
}

var timeoutId;
function showNextMove(moveTime) {
    moveTime = moveTime ?? getMoveTime();
    if (timeoutId) {
        clearTimeout(timeoutId)
        timeoutId = undefined
    }

    let timeScale;
    while (!timeScale) {
        if (moveTime === 0) {
            constructBoard(moves.pop());
            return;
        } else if (moves.length === 1) {
            updateBoard(moves.shift());
            QQ('.highlight').map(x => x.classList.remove(...list('highlight down across')))
            setTimeout(() => QQ('.v2').map(x => x.classList.add(...list('slow done'))))
            return;
        } else {
            timeScale = updateBoard(moves.shift());
        }
    }

    timeoutId = setTimeout(showNextMove, moveTime * timeScale);
}

function getMoveTime(sliderVal) {
    sliderVal = sliderVal || (timeoutId ? document.querySelector('#slider input').value : 0);

    sliderVal = Math.max(0, Math.min(sliderVal, 100))

    return Math.ceil(
        Math.pow(sliderVal, 3) / 500
    );
}

/*

Main Script

*/
let hello = {
    title: 'Hello',
    down: '3 9 11 4,2 2 1 6 3,2 2 6 6 2,3 4,2 2 3,2 10 2,5 2,6,2 4,2 3,2 10 2,5 2,6,2 4,2 2 2 4 6 1,2 2,2 5',
    across: '2,2,2 2,4,4 2,1,1,1,1 2,1,2,1,2 2,1,2,1,2 2,2,2,1,2,1 2,3,4,2,1,2,1,3 4,2,2,1,4,4,2,2 3,2,2,1,3,3,2,1 2,2,4,2,2,3,1 3,1,3,3,3,4,1 2,4,4,4,4,4 2,2,2,2,2,2'
}

let board = solve(parseNums(hello.down), parseNums(hello.across));
constructBoard(board);

let examples = [
    /*{
        down: '1 1',
        across: '1 1'
    },*/
    {
        title: 'Gull',
        down: '1,1 2,1 1 2',
        across: '2 1 1,2 1,1'
    },
    {
        title: 'Bug',
        puzzle: `8x8
0 1,1 1,4 1 1 1,4 1,1 0
0 1,1 0 2,2 1,1 2,2 4 0`,
    },
    {
        title: 'Elephant Beetle',
        puzzle: `8x8
0 1,1 1,4 1 1 1,4 1,1 0|0 0 0 5 5 0 0 0
0 1,1 0 2,2 1,1 2,2 4 0|0 2 2 2 2 2 0 0`,
    },
    {
        title: 'Pine Cone',
        down: '2 5 2,3 1,2,1 6 3,1 5 2',
        across: '2 5 1,3 6 1,2,1 3,2 5 2'
    },
    /*{
        title: 'Invader',
        down: '3 2 1,5 2,2,1 4,1 4 4,1 2,2,1 1,5 2 3',
        across: '1,1 1,1 7 2,3,2 11 1,7,1 1,1,1,1 2,2'
    },
    {
        title: 'Chameleon',
        down: '1,2 1,4 2,1,1,2 3,1,2 1,5,3 11 4,4 9 8 6 5 3',
        across: '2 1,4 8 9 1,7 5,4 8 2,7 2,4,1 2,4 5 3'
    },*/
    {
        title: 'Kitty',
        down: '1,2 4,1,1 3,6 7 3,6 4,4 1,3 2 3,1 2,3',
        across: '1,1 2,2 5 2,1,2,1 5,2 3,1 6,2 1,5,1 8 2,4'
    },
    // {
    //     title: 'Skull',
    //     down: '7 2,2,3 2,2,1 1,2 1,1,1 1,2 1,2,1 1,2,3 2,3 2,3 7',
    //     across: '7 2,2 2,2 1,1 1,1 3,2,1 3,1,2,1 1,2 2,4 1,1,1,3 8'
    // },
    {
        title: 'Panda',
        down: '2,7 6,5 3,2 4,3,2 3,5,1 2,1,3,1,2 2,4,2,2 1,2,4 2,4,2,2 2,1,3,1,2 3,5,1 4,3,2 3,2 6,5 2,7',
        across: '2,2 13 7,7 4,4 1,3,3,1 2,2,1,1,2,2 2,4,4,2 1,4,4,1 2,2,1,2,2 2,1,2 2,2,2,2 2,3,2 3,1,3 11 5'
    },
    {
        title: 'Scorpion',
        down: '5 2,1 2,4 1,1,1 2,2 5 6,2 3,2,2,1 1,3,1,1,1 1,1,2,2,1 2,1,1,1,1,1 1,1,1,1,1,2 3,2,1,1,2,1,2 5,1,5,2 2,1,1,9 3,2,6,1 2,2,2,3,4 1,2,4,1,1 6,4 1',
        across: '6 1,6 1,2,1,1 1,1,3 2,3 1,1,1 4,5 2,3,2,3 2,3,3,2,1 1,1,4,2,3 1,1,4,4 1,1,1,1,2,7 1,2,3,6,1 2,3,4,1 3,1,1,2 1,1,1,1 1,2,2,2 4,3 1,2,2 5'
    },
    {
        title: 'Man with Pipe',
        down: '2,2,1 1,6,4,4 3,3,1,1,4 2,2 1,3,3,3 1,1,1,2,1,2 2,1,1,1,1 2,4,3,3 3,1,2,3,1 1,4,2,1 3,1,2 2,1,1 3,3 7,4 5,4 3,2,1,3 3,4,1 9,2 8,3 1,8,2',
        across: '1,3,2,1 1,2,2 3,4 2,3,2 2,1,6 2,13,1 1,1,8 2,1,1,7 1,2,2,2,3 3,1,1,1,3 1,2,1,1,3 2,1,1,3 1,5,5 1,1,3 4,2 2,2,1,2,1 2,1,2,3,2 4,1,6,1 3,4,3,2 4,2'
    },
    {
        title: 'Bird',
        down: '0 1 1 4 2,3 7 9,1 6,3,2 4,2,2 3,2,1,3 6,2,5 7,1,2,3 7,3,3 7,2,3 7,1,3 6,1,4 8,5 6,3,3 7,3 3,3,4 3,3,3 3,2,3 4,1,3 3,1,4 2,3 1,3',
        across: '0 4 6,2 1,5,6 14,7 20 4,10 2,10 1,12 2,14 1,11 2,1 3,5 4,1 1,2,3 2,1,7 2,11 1,11 11 9 7'
    },
    /*{
        title: 'Pterodactyl',
        down: '1 2 3,1 3,2 5,2,1 6,3,2 14 12 11 5 1,6 2,8 4,4 1,2,5 4,6 1,1,7 1,1,6 1,1,5 1,1,4 1,1,3',
        across: '3 4 5 6,2 5,4 5,1,6 4,4 4,10 6 6,2 11 13 14 2,3,7 2,5 2,4 2,3 3 2 1'
    },*/
    hello,
]
const parseCommonNonogramFormat = (str) => str.trim().split('\n').slice(-2)
const unparseCommonNonogramFormat = (down, across) => {
    if (!down[0][0].length) {
        ;[down, across] = [[down], [across]]
    }
    console.debug('unparse', down, across)
    return `${across[0].length}x${down[0].length}\n${lists.joins(down, '|', ' ', ',')}\n${lists.joins(across, '|', ' ', ',')}`
}
examples.map(x => {
    if (x.puzzle) {
        ;[x.down, x.across] = parseCommonNonogramFormat(x.puzzle)
    }
})

const displayPuzzle = (down, across) => constructBoard(solve(down, across, true))
const query = new URLSearchParams(location.search)
let show_morse_code = JSON.parse(query.get('mc') || 'false')
let show_placement_guide = JSON.parse(query.get('pg') || 'false')
let show_sequential_display = JSON.parse(query.get('sd') || 'false')
const updateQuery = ({ mc, pg, sd }={}) => {
    console.debug({mc, pg})
    // query.set('mc', Q('#morse-label input').checked = show_morse_code = mc ?? show_morse_code)
    query.set('pg', Q('#placement-label input').checked = show_placement_guide = pg ?? show_placement_guide)
    query.set('sd', Q('#sequential-label input').checked = show_sequential_display = sd ?? show_sequential_display)
    url.query(query, { remove_false:true })

    html.classList[show_morse_code ? 'add' : 'remove']('morse')
    html.classList[show_placement_guide ? 'add' : 'remove']('guide')
    html.classList[show_sequential_display ? 'add' : 'remove']('sequential')
    displayExample()
    if (mc !== undefined && !mc) defer(() => location.reload(), 100)
    else defer(resizeBoard)
}
// on(Q('#morse-label input'), 'change', e => updateQuery({ mc:e.target.checked }))
on(Q('#placement-label input'), 'change', e => updateQuery({ pg:e.target.checked }))
on(Q('#sequential-label input'), 'change', e => updateQuery({ sd:e.target.checked }))
defer(updateQuery, 100)

let _display_example, _display_i = -1
const _display_cleaup = []
const displayExample = (example_or_title_or_i=_display_example) => {
    const display_i = (_display_i += 1)
    _display_cleaup.map(apply)
    lists.clear(_display_cleaup)

    const example = _display_example = typeof(example_or_title_or_i) === 'object' ? example_or_title_or_i : examples[examples.findIndex(x => x.title === example_or_title_or_i)] || examples[example_or_title_or_i]
    console.debug(example)
    const board = solve(parseNums(example.down), parseNums(example.across), true, true)
    constructBoard(board, false)
    Q('[name=down]').value = Q('#display-input-down').textContent = example.down
    Q('[name=across]').value = Q('#display-input-across').textContent = example.across

    const display = { empty: '0', sep: '-', break: '' }
    Q('#display-input-down').innerHTML = example.down.split('|').map(y => `<span>${y.split(' ').map(x =>`<span>${x === '0' ? display.empty : x.split(',').join(display.sep)}</span>`).join('')}</span>`).join(display.break)
    Q('#display-input-across').innerHTML = example.across.split('|').map(y => `<span>${y.split(' ').map(x => `<span>${x === '0' ? display.empty : x.split(',').join(display.sep)}</span>`).join('')}</span>`).join(display.break)
    // Q('#display-input-down').innerHTML = example.down.split('|').map(y => `<span>${y.split(' ').map(x =>`<span>${x}</span>`).join('')}</span>`).join('')
    // Q('#display-input-across').innerHTML = example.across.split('|').map(y => `<span>${y.split(' ').map(x => `<span>${x}</span>`).join('')}</span>`).join('')

    Q('#input-controls').classList.remove('input-empty')
    // Q('#name-label').textContent = example.title || example.name
    html.classList[example.color ? 'add' : 'remove']('colored')
    Q('#example-color-style')?.remove()
    if (example.color) {
        const [c_default, c_0, c_1, c_2] = example.color.split('|')
        head.append(node(`<style id=example-color-style>
            .board:first-child {
                --fill-color-default: ${c_default};
                ${c_0 ? `--fill-color-0: ${c_0};` : ''}
                ${c_1 ? `--fill-color-1: ${c_1};` : ''}
                ${c_2 ? `--fill-color-2: ${c_2};` : ''}
            }
        </style>`))
    }

    if (show_morse_code) {
        dependency('/lib/2/morse.js')
        const str_for_morse_code = [dims(board).join('x'), example.down, example.across].join('-').replace(/\|/g, '/')
        const _displayMorse = () => {
            // morse.for(str_for_morse_code, {
            //     element: '#display-input > *', unit_ms: 500,
            //     on_style: '', off_style: 'background: #0000 !important',
            // })
            morse.for(str_for_morse_code, {
                element: 'html', unit_ms: 500,
                on_style: 'background: #000 !important', off_style: '',
            })
        }
        const morse_code = _displayMorse()
        const timeout = setInterval(_displayMorse, math.sum(morse_code) * 500)
        cleanup.push(() => clearTimeout(timeout))
        console.debug({str_for_morse_code, morse_code})
    }

    Q('#sequential-display-container')?.remove()
    if (show_sequential_display) {
        document.body.append(node(`<div id=sequential-display-container><div id=sequential-display-container-inner><div id=sequential-display></div></div>`))
        // board.map((layer, i) => {
        //     const [layer_down_sequence, layer_across_sequence] = [layer.down, layer.across].map((side, i) => 
        //     side
        //     .map((list, i,a) => `<div class="middle-${window.width < window.height ? 'column' : 'row row-reverse'}" style="gap: .67em"><div class=appear-100>${list.join(', ')}</div><div style="font-size:.33em">${i} of ${a.length}</div></div>`)
        //     .map((item, j) => [
        //         item,
        //         () => QQ(top.document.body, '#display-input > * > * > *')[cell_i += 1],
        //         `
        //         background: red;
        //         `])
        //     )
        //     console.debug('layer', layer, layer_down_sequence, layer_across_sequence)
        //     sequence.push([
        //         `layer ${i + 1}`,
        //         () => {
        //             const ls = QQ(top.document.body, '#display-input > * > *')
        //             return range(layer_i += 1, ls.length, board.length).map(i => ls[i])
        //         },
        //         `
        //         box-shadow: 0 0 0 var(--display-pad-outer) var(--fill-color-1);
        //         `])
        //     sequence.push([
        //         `top (${layer_down_sequence.length})`,
        //         () => QQ(top.document.body, '#display-input > * > *')[group_i += 1],
        //         `
        //         box-shadow: 0 0 0 var(--display-pad-outer) var(--fill-color-1);
        //         `])
        //     sequence.push(...layer_down_sequence)
        //     sequence.push([
        //         `side (${layer_across_sequence.length})`,
        //         () => QQ(top.document.body, '#display-input > * > *')[group_i += 1],
        //         `
        //         box-shadow: 0 0 0 var(--display-pad-outer) var(--fill-color-1);
        //         `])
        //     sequence.push(...layer_across_sequence)
        // })
        if (display_i === _display_i) {
            ;(async () => {
                const sequence_ms = 2_000
                const ms_pause_fill = (ms) => range(Math.ceil(ms / sequence_ms)).map(_=>0)
                const vertical = window.innerWidth < window.innerHeight
                
                const l = Q('#sequential-display')
                const display_l = Q(top.document.body, '#display-input')
                const display = (major, minor='', _vertical=vertical) => node(
                    `<div class="middle-${_vertical||1 ? 'column' : 'row'}" style="gap:${_vertical?0:0}">
                        <div class=appear-100 style="line-height:1">${major}</div>
                        <div style="font-size:${_vertical ? '.33em' : '.25em'}">${minor}</div>
                    </div>`).outerHTML
                
                const overview = [
                    `<div class=column style="flex-grow:1;z-index:1;text-transform:none">
                        <div class=row>
                            <div style="visibility:hidden">${board[0].across.length}x</div>
                            <div style="background:var(--fill-color-1)">x${board[0].down.length}</div>
                        </div>
                        <div class=row style="flex-grow:1">
                            <div style="background:var(--fill-color-2)">x${board[0].across.length}</div>
                            <div class=row style="position:relative;z-index:-1;width:-webkit-fill-available;aspect-ratio:${board[0].down.length}/${board[0].across.length}">
                                ${board.length > 1 ? `${board.length}x` : ''}${board[0].down.length}x${board[0].across.length}
                                ${board.map((_,i) => `<div class=fill style="z-index:${board.length - i};border:1px solid #000;background:#fff;translate:-${i * 2}px -${i * 2}px;"><span style="color:#fff;background:#000;display:inline-block;translate:-1px -1px">${i ? '' : `${board.length > 1 ? `x${board.length}` : ''}`}</span></div>`).join('')}
                            </div>
                            </div>
                        </div>
                    </div>`,
                    () => QQ(display_l, ':scope > *')[0],
                    `
                    background: var(--fill-color-1);
                    `]
                
                const sequence = [
                    // ' ', ...ms_pause_fill(30_000),
                    // 'nonogram',
                    // display('nonogram', 'no.tu.fo', true),
                    display('nonogram', '', true),
                    // `
                    // <div>planning to do drugs?</div>
                    // <div style="color:#fff;background:#000">do a nonogram instead</div>
                    // `,
                    // `${board[0].down.length}x${board[0].across.length}`,
                    // `<div>TOP</div>
                    // <div style="flex-grow:1">LEFT<div class=middle style="width:-webkit-fill-available;aspect-ratio:${board[0].down.length}/${board[0].across.length};border:1px solid currentcolor">${board[0].down.length}x${board[0].across.length}</div></div>`,
                    overview,
                    ...ms_pause_fill(sequence_ms * 2),
                    // ...range(100).map(x=>0),
                ]
                console.debug('define sequential display for', board, l, display_l)
                const layer_count_sums = board.map(layer => layer.length).reduce((a, v) => a.concat(a[a.length - 1] + v), [0])
                let group_i = -1, cell_i = -1
                ;list('down across').map(x => board.map(layer => layer[x])).map((side_layers, side_i) => {
                    const label = ['top', 'side'][side_i]
                    const type = ['column', 'row'][side_i]
                    // sequence.push([
                    //     `${label} (${side[0].length})`,
                    //     () => QQ(display_l, ':scope > *')[side_i],
                    //     `
                    //     background: var(--fill-color-1);
                    // `])
                    side_layers.map((side, layer_i) => {
                        const side_sequence = side
                        .map((list, i,a) => display(
                            `<span style="font-size:1.33em;line-height:1">${list.join('-')}</span>`,
                            `layer ${layer_i + 1} ${type} ${i + 1}`))
                        .map((item, j) => [
                            item,
                            () => QQ(display_l, ':scope > * > * > *')[cell_i += 1],
                            // () => [].concat(
                            //     QQ(display_l, ':scope > * > * > *')[cell_i += 1],
                            //     [QQ(display_l, ':scope > *')[side_i]],
                            // ),
                            `
                            background: var(--fill-color-1);
                            `])
                        sequence.push([
                            display(`${[layer_i, side_i].map(x=>x+1).join(':')}`, `layer ${layer_i + 1} ${type}s`),
                            () => QQ(display_l, ':scope > * > *')[group_i += 1],
                            `
                            box-shadow: 0 0 0 var(--display-pad-outer) var(--fill-color-1);
                            `],
                            ...ms_pause_fill(sequence_ms))
                        // sequence.push([
                        //     display(`layer ${layer_i + 1} ${type}s`, `${[layer_i, side_i].map(x=>x+1).join('-')}\n${side.length} ${type}s`),
                        //     () => (ols => [].concat(
                        //         ols,
                        //         (ls => [].concat(
                        //             ls,
                        //             ls.flatMap(l => QQ(l, ':scope > :nth-child(2n + 1)')),
                        //         ))([ols.flatMap(l => QQ(l, ':scope > *'))[layer_i]]),
                        //     ))([QQ(display_l, ':scope > *')[side_i]]),
                        //     `
                        //     background: var(--fill-color-1);
                        //     `],
                        //     0)
                        sequence.push(...side_sequence)
                    })
                })
                sequence.push(overview, ...ms_pause_fill(10_000), '<div style="display:none"></div>', ...ms_pause_fill(30_000))
                console.debug('defined display sequence', sequence)

                let i = 0, prev_display_ls, prev_display_styles
                while (display_i === _display_i) {
                    const item = sequence[(i++)%sequence.length]
                    if (item) {
                        prev_display_ls?.map(x => {
                            x.style.cssText = ''
                            delete x.dataset['sequential_highlight']
                        })
                        prev_display_styles?.map(x => x.remove())
                        if (Array.isArray(item)) {
                            l.innerHTML = item[0]
                            const display_ls = prev_display_ls = (x => Array.isArray(x) ? x : [x])(item[1]()).filter(pass)
                            const _save_cssText = display_ls.map(x => x.style.cssText)
                            // + `
                            // color: var(--fill-color-1) !important;
                            // background: currentcolor !important;
                            // border-color: currentcolor !important;
                            // box-shadow: none !important;
                            // `
                            // prev_display_styles = display_ls.map((x, i) => {
                            //     x.dataset['sequential_highlight'] = i
                            //     const style_l = node(`<style>
                            //         [data-sequential_highlight="${i}"] > :not(style) {
                            //             visibilty: hidden !important;
                            //         }
                            //         style {
                            //             display: none !important;
                            //         }
                            //     </style>`)
                            //     x.append(style_l)
                            //     return style_l
                            // })
                            display_ls.map(x => x.style.cssText += item[2])
                        } else {
                            l.innerHTML = item
                        }
                        l.style.scale = 1
                        l.style.scale = Math.min(l.parentNode.clientWidth / l.clientWidth, l.parentNode.clientHeight / l.clientHeight) * .95

                        html.style.background = body.style.background = String(item).trim() ? '' : 'transparent'
                    }
                    await sleep(sequence_ms)
                }
            })()
        }
    }
}
Q('#examples').append(...entries(examples).map(([k,v], i) => node(`<a onclick="displayExample(${i})">${k.title?.toLowerCase() || (i+1)}</a>`)))


var down, across;
// let nonogram_format_regex
// fetch('https://freshman.dev/raw/nonogram/.no').then(r=>r.text()).then(text => nonogram_format_regex = new RegExp(text))
// on(QQ('#inputs input'), 'input', e => {
//     const match = nonogram_format_regex.test(e.target.value)
//     if (match) {
//         Q('[name=down]').value = match.group(3)
//         Q('[name=across]').value = match.group(4)
//     }

//     timeoutId && showNextMove(0)

//     let formData = new FormData(document.querySelector('form'));

//     let downInput = formData.get('down');
//     let acrossInput = formData.get('across');

//     let re = /^ *\d{1,2}(,\d{1,2})*( (\d{1,2}(,\d{1,2})*)?)*$/

//     down = (downInput.match(re)) ? parseNums(downInput) : down;
//     across = (acrossInput.match(re)) ? parseNums(acrossInput) : across;

//     // if (!(down.length > 1 && across.length > 0))
//     if (!down || !across) {
//         return;
//     }

//     displayPuzzle(down, across)
// });
on('#solve-input input', 'input change', e => {
    timeoutId && showNextMove(0)

    let formData = new FormData(document.querySelector('form'));

    let downInput = formData.get('down');
    let acrossInput = formData.get('across');

    let re = /^ *(\d{1,2}(,\d{1,2})*( (\d{1,2}(,\d{1,2})*)?)*\|?)*$/
    down = (downInput.match(re)) ? parseNums(downInput) : down;
    across = (acrossInput.match(re)) ? parseNums(acrossInput) : across;

    // if (!(down.length > 1 && across.length > 0))
    const input = down && across
    Q('#input-controls').classList[input ? 'remove' : 'add']('input-empty')
    if (!input) return

    displayPuzzle(down, across)
});
ons('#solve-input', {
    'paste': e => {
        e.preventDefault()
        console.debug((event.clipboardData || window.clipboardData).getData('text'))
        const [down, across] = parseCommonNonogramFormat((event.clipboardData || window.clipboardData).getData('text'))
        Q('[name=down]').value = down
        Q('[name=across]').value = across
        displayPuzzle(parseNums(down), parseNums(across))
    },
});

const performSolve = e => {
    let formData = new FormData(document.querySelector('form'));
    let downInput = formData.get('down');
    let acrossInput = formData.get('across');

    let re = /^ *(\d{1,2}(,\d{1,2})*( (\d{1,2}(,\d{1,2})*)?)*\|?)*$/
    if (!downInput.match(re) || !acrossInput.match(re)) {
        // $('#inputs').effect('shake')
        errorElement(document.querySelector('#inputs button'))
        return;
    }

    let down = parseNums(downInput);
    let across = parseNums(acrossInput);

    const showInputError = (i, message) => {
        const input = document.querySelectorAll('input')[i]
        const value = input.value
        input.value = message
        const _clearInputError = () => {
            input.value = value
            clearTimeout(timeoutHandle)
            input.removeEventListener(listenerHandle)
        }
        const timeoutHandle = setTimeout(_clearInputError, 3000)
        const listenerHandle = input.addEventListener('click', _clearInputError)
    }
    if (down.length > MAX_INPUT_DIM) showInputError(0, 'Too many columns');
    if (across.length > MAX_INPUT_DIM) showInputError(1, 'Too many rows');

    if (down.length <= MAX_INPUT_DIM && across.length <= MAX_INPUT_DIM) {
        // showSolve(down, across);
        constructBoard(solve(down, across, false, true))
    } else {
        errorElement(document.querySelector('#inputs button'))
    }
}
on('#solve-button', 'click', performSolve);
on('#copy-button', 'click', e => {
    const inputs = [Q('[name=down]').value, Q('[name=across]').value]
    const [down, across] = inputs.map(parseNums)
    copy(unparseCommonNonogramFormat(down, across))
    displayStatus(e.target, 'copied!')
})
on('#clear-button', 'click', e => {
    Q('#examples > *:last-child').click()
    Q('#solve-button').click()
    Q('[name=down]').value = Q('[name=across]').value = ''
})
on('#theme-select', 'change click', e => {
    document.documentElement.classList.remove(...list('grayscale red yellow'))
    document.documentElement.classList.add(...list(e.target.value))
})
Q('#theme-select').value = 'yellow'
// on('#copy-button', 'click', e => {
//     let formData = new FormData(document.querySelector('form'));
//     let downInput = formData.get('down');
//     let acrossInput = formData.get('across');
//     let down = parseNums(downInput);
//     let across = parseNums(acrossInput);
//     copy(``)

//     const showInputError = (i, message) => {
//         const input = document.querySelectorAll('input')[i]
//         const value = input.value
//         input.value = message
//         const _clearInputError = () => {
//             input.value = value
//             clearTimeout(timeoutHandle)
//             input.removeEventListener(listenerHandle)
//         }
//         const timeoutHandle = setTimeout(_clearInputError, 3000)
//         const listenerHandle = input.addEventListener('click', _clearInputError)
//     }
//     if (down.length > MAX_INPUT_DIM) showInputError(0, 'Too many columns');
//     if (across.length > MAX_INPUT_DIM) showInputError(1, 'Too many rows');

//     if (down.length <= MAX_INPUT_DIM && across.length <= MAX_INPUT_DIM) {
//         // showSolve(down, across);
//         constructBoard(solve(down, across))
//     } else {
//         errorElement(document.querySelector('#inputs button'))
//     }
// });

// const save_widget = Q('#save-widget')
// const save_button = Q(save_widget, 'a')
// const save_select = Q(save_widget, 'select')
// on(save_select, 'change', e => {
//     const l = e.target
//     switch (l.value) {
//         case 'image':{
//             downloadCanvas(boardToCanvas(), `${Q('#name-label').textContent.replace(/ /g, '_')}.png`)
//         }break
//         case 'export':{
//             const [down, across] = [Q('[name=down]').value, Q('[name=across]').value].map(parseNums)
//             download(unparseCommonNonogramFormat(down, across), `${Q('#name-label').textContent}.no`)
//             // displayStatus(Q(save_widget, 'a'), 'copied!')
//         }break
//     }
//     l.value = 'cancel'
//     l.click()
// })
// on(save_button, 'click', e => {
//     console.debug(e)
//     save_select.click()
// })
on('#save-button', 'click', e => {
    downloadCanvas(boardToCanvas(), `${Q('#name-label').textContent.replace(/ /g, '_')}.png`)
})
// const [down, across] = [Q('[name=down]').value, Q('[name=across]').value].map(parseNums)
// download(unparseCommonNonogramFormat(down, across), `${Q('#name-label').textContent}.no`)
// on(Q('#save-select'), 'change', e => {
//     const l = e.target
//     switch (l.value) {
//         case 'image':{
//             downloadCanvas(boardToCanvas(), `${Q('#name-label').textContent.replace(/ /g, '_')}.png`)
//         }break
//         case 'export':{
//             const [down, across] = [Q('[name=down]').value, Q('[name=across]').value].map(parseNums)
//             download(unparseCommonNonogramFormat(down, across), `${Q('#name-label').textContent}.no`)
//             // displayStatus(Q(save_widget, 'a'), 'copied!')
//         }break
//     }
//     l.value = 'cancel'
//     l.click()
// })

on('#reset-button', 'click', e => {
    constructBoard(solve(parseNums(Q('[name=down]').value), parseNums(Q('[name=across]').value), true, true))
})


// new board resizing code
let boardEl = document.querySelector('#objects')
let bodyEl = document.querySelector('body')
let rI
function resizeBoard() {
    let tableEl = document.querySelector('#objects table')
    if (tableEl) {
        let boardRect = boardEl.getBoundingClientRect()
        let bodyRect = bodyEl.getBoundingClientRect()
        let tableRect = tableEl.getBoundingClientRect()
        // console.log(boardRect, tableRect)
        let scale = Math.round(Math.min(
            bodyRect.width / (tableRect.width + 120),
            boardRect.height / tableRect.height) * 100)/100;
        scale = Math.min(scale, bodyRect.width / (boardRect.width * 1.35))
        // scale = (scale - 1) * .9 + 1;
        // console.log(`scale(${scale});`)
        // rI && clearInterval(rI)
        // rI = setInterval(() => $('#board table').css('transform', `scale(${scale})`), 100)
        setTimeout(() => {
          QQ('#objects table').map(x => x.style.cssText = `
          visibility: visible;
          `)
        }, 50)
        // $('#board table').css('transform', `scale(${scale})`)y

        // tableEl.style.transform = `scale(${scale});`
    }

    // const object_l = Q('#objects')
    // Object.assign(object_l.style, {
    //     'scale': Math.max(1, (Q('#ui').clientWidth * .6) / (object_l.clientWidth * 1.5)),
    //     'transform-origin': '0 0',
    // })
    // const object_l = Q('#objects')
    // const object_rect = object_l.getBoundingClientRect()
    // Object.assign(object_l.style, {
    //     // 'scale': Math.max(1, (Q('#ui').clientWidth * .6) / (object_l.clientWidth * 1.5)),
    //     // 'transform-origin': '0 0',
    //     'scale': Math.max(1, (object_rect.height * .8) / ((rect => {
    //         return rect.y + rect.height
    //     })(Q(object_l, '.board:last-child').getBoundingClientRect()) - object_rect.y)),
    //     'transform-origin': '0 0',
    // })

    const display_l = Q('#display-input')
    let fontsize = 20
    while (display_l.clientWidth < Q('#ui').clientWidth) {
        display_l.style.fontSize = (fontsize += 1)+'px'
    }
    display_l.style.fontSize = (fontsize - 1)+'px'
}
window.addEventListener('resize deviceorientation', resizeBoard)
displayExample('Elephant Beetle')

const start_ms = Number(datetime.of({ Y:2023, M:7, D:10 }))
const is_development = location.hostname === 'localhost' || location.port === '3030'
const today_ms = location.hash?.slice(1) ? Number(datetime.new(location.hash.slice(1))) : Date.now() + (is_development ? datetime.duration({ d:1 }) : 0)
console.debug({ start_ms, is_development, today_ms, start:datetime.ymd(start_ms), today:datetime.ymd(today_ms) })
let last_puzzle_ms
defer(async () => {
    const format = eval(`/${await api.get(`/raw/nonogram/puzzles/no.format`).then(r=>r.text())}/`)

    let puzzle_ms = today_ms
    const load_ms = (ms) => {
        open(location.origin + location.pathname + location.search + '#'+datetime.ymd(ms), '_self')
        load_puzzle(ms)
    }
    const load_puzzle = async t => {
        const new_puzzle_ms = Math.max(start_ms, Math.min(t, location.hostname === 'localhost' ? Date.now() + duration({ mo: 1 }) : today_ms))
        const puzzle = await api.get(`/raw/daily-nonogram/puzzles/${datetime.yyyymmdd(new_puzzle_ms)}.no`).then(r=>r.text())
        console.debug({ puzzle, format })

        const variants = list(puzzle.matchAll(new RegExp(format, 'g'))).map(x => ({...x.groups}))
        console.debug({ variants })
        if (!variants.length) return load_ms(last_puzzle_ms ? last_puzzle_ms : Date.now())
        puzzle_ms = last_puzzle_ms = new_puzzle_ms
        Q('#variant-button').classList[variants.length > 1 ? 'remove' : 'add']('hidden')

        let variant_i = -1
        const nextVariant = () => {
            const object = variants[variant_i = (variant_i + 1) % variants.length]
            Q('#variant-button').textContent = `variant${variants.length > 1 ? ` ${variant_i + 1}` : ''}`
            console.debug({ object })
            displayExample(object)
            defer(() => {
                Q('#name-label').textContent = datetime.ymd(t)
                url.replace(location.origin + location.pathname + location.search + (new_puzzle_ms === today_ms ? '' : `#${datetime.yyyymmdd(new_puzzle_ms)}`))
                resizeBoard()
            }, 100)
            if (!examples.find(x => (x.title || x.name) === (object.title || object.name))) examples.push(object)
        }
        on('#variant-button', 'click', e => nextVariant())
        Q('#variant-button').click()
    }
    load_puzzle(puzzle_ms)
    // on('#first-button', 'click', e => load_puzzle(start_ms))
    // on('#previous-button', 'click', e => load_puzzle(puzzle_ms - datetime.duration({ d: 1 })))
    // on('#random-button', 'click', e => load_puzzle(rand.i(today_ms - start_ms) + start_ms))
    // on('#next-button', 'click', e => load_puzzle(puzzle_ms + datetime.duration({ d: 1 })))
    // on('#last-button', 'click', e => load_puzzle(today_ms))

    // const load_ms = (ms) => location.href = location.origin + location.pathname + '#'+datetime.ymd(ms)
    on('#first-button', 'click', e => load_ms(start_ms))
    on('#previous-button', 'click', e => load_ms(puzzle_ms - datetime.duration({ d: 1 })))
    on('#random-button', 'click', e => load_ms(rand.i(today_ms - start_ms) + start_ms))
    on('#next-button', 'click', e => load_ms(puzzle_ms + datetime.duration({ d: 1 })))
    on('#last-button', 'click', e => load_ms(today_ms))
})
on(window, 'resize', resizeBoard)
if (is_development) Q('#solve-button').classList.remove('hidden')

  </script>

</body>
</html>
